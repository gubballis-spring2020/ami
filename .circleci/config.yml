version: 2
jobs:
  build:
    docker:
      - image: hashicorp/packer:1.1.1
    steps:
      - checkout
      - run:
          name: Validate packer config
          command: | 
            packer validate \
            -var 'aws_access_key=${AWS_ACCESS_KEY}' \
            -var 'aws_secret_key=${AWS_SECRET_KEY}' \
            -var 'aws_region=us-east-1' \
            -var 'ami_users=${AMI_USERS}' \
            -var 'source_ami=${SOURCE_AMI}' \
            ubuntu-ami.json

      - run:
          name: Build packer config
          command: | 
            packer build \
            -var 'aws_access_key=${AWS_ACCESS_KEY}' \
            -var 'aws_secret_key=${AWS_SECRET_KEY}' \
            -var 'aws_region=${AWS_REGION}' \
            -var 'ami_users=${AMI_USERS}' \
            -var 'ssh_username=${SSH_USER}' \
            -var 'source_ami=${SOURCE_AMI}' \
            ubuntu-ami.json

           
workflows:
  version: 2
  build-deploy-workflow:
    jobs:
      - build:
          filters:
            branches:
              only:
                - master
  